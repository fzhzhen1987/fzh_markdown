# 21.宏定义与使用分析

- [一.C语言中的宏定义](#1)
- [二.宏定义表达式](#2)
- [三.宏表达式与函数对比](#3)
- [四.强大的内置宏](#4)
- [非常有用的宏](#4)

---
<h4 id="1">[一.C语言中的宏定义]</h>

- #define 是 **预处理器** 处理器处理的单元实体之一  
- #define 定义的宏可以出现在程序的 **任意位置**  
- #define 定义之后的代码都可以使用这个宏  

	定义宏常量  
	- #define 定义的宏常量可以直接使用  
	- #define 定义的宏常量本质为 **字面量**,字面量 **不会占用内存**  

[**test_1.c代码**](21/test_1.c)  
单步编译test_1.c  
```shell
gcc -E test_1.c -o test_1.i
使用单步预编译是可以通过的,但是编译是不能通过.
```
[**单步编译生成的test_1.i**](21/test_1.i)  

<h4 id="2">[二.宏定义表达式]</h>

- #define 表达式的使用 **类似** 函数调用  
- #define 表达式可以 **比函数更强大**  
- #define 表达式 **比函数更容易出错**  

[**test_2.c代码分析**](21/test_2.c)  
单步编译test_2.c  
`gcc -E test_2.c -o test_2.i`  
[**单步编译生成的test_2.i**](21/test_2.i)  

[**编译执行test_2-1.c**](21/test_2-1.c)  
```shell
gcc test_2-1.c -o test_2-1.out
❯ ./test_2-1.out
s1 = 3
s2 = 5
m = 2
d = 4
```

<h4 id="3">[三.宏表达式与函数对比]</h>

- 宏表达式被 **预处理器** 处理,编译器不知道宏表达式的存在  
- 宏表达式用 **"实参"** 完全替换形参属于 **文本替换,不会进行任何运算**  
- 宏表达式 **没有任何的调用开销**  
- 宏表达式中 **不能出现递归定义**  

**宏表达式的常量或表达式是否有 *作用域* 限制**
- 结论:作用域的概念针对函数和变量,不适用于 **宏定义**  

[**test_3.c代码分析**](21/test_3.c)  
单步编译test_3.c  
`gcc -E test_3.c -o test_3.i`  
[**单步编译生成的test_3.i**](21/test_3.i)  

<h4 id="4">[四.强大的内置宏]</h>

| 宏           | 含义                    | 实例        |
|--------------|-------------------------|-------------|
| \_\_FILE\_\_ | 被编译的文件名          | file.c      |
| \_\_LINE\_\_ | 当前行号                | 25          |
| \_\_DATE\_\_ | 编译时的日期            | Jan 31 2012 |
| \_\_TIME\_\_ | 编译时的时间            | 17:01:21    |
| \_\_STDC\_\_ | 编译器是否遵循标准C规范 | 1           |

[**test_4.c 综合实例**](21/test_4.c)  
单步编译test_4.c  
`gcc -E test_4.c -o test_4.i`  
[**单步编译生成的test_4.i**](21/test_4.i)  


[**编译执行test_4-1.c**](21/test_4-1.c)  
```shell
❯ gcc test_4-1.c -o test_4-1.out
❯ ./test_4-1.out
[Mar 10 2022] {21-4.c:19} Begin to run main code...
0
1
2
3
4
[Mar 10 2022] {21-4.c:33} End
```
--------

<h4 id="5">[非常有用的宏]</h>

```c
#define MALLOC(type, x) (type*)malloc(sizeof(type)*x)
#define FREE(p) (free(p), p=NULL)
#define LOG(s) printf("[%s] {%s:%d} %s \n", __DATE__, __FILE__, __LINE__, s)
```

